<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fanqie.dc.dao.IOperateTrendDcDao">
   <resultMap id="mapId" type="com.fanqie.dc.domain.OperateTrend">
        <result column="id" property="id"/>
        <result column="inn_id" property="innId"/>
        <result column="name" property="innName"/>
        <result column="mobile" property="mobile"/>
        <result column="total_room_num" property="totalRoomNum"/>
        <result column="real_live_num" property="realLiveNum"/>
        <result column="total_income" property="totalIncome"/>
        <result column="empty_room_num" property="emptyRoomNum"/>
        <result column="create_date" property="createdDate"/>
        <result column="user_code" property="innCode"/>
        <result column="live_percent" property="livePercent"/>
        <result column="avg_price" property="avgPrice"/>
   </resultMap>



    <insert id="saveOperateTrend" parameterType="java.util.Map">
        insert into operate_trend(id,inn_id,inn_name,mobile,create_date,total_income,total_room_num,real_live_num,empty_room_num,avg_price,live_percent,inn_code)
        values
        <if test="list.size() > 0">
            <foreach collection="list" item="v" separator=","  >
                ( '${v.uuid}',#{v.innId},'${v.innName}','${v.mobile}',#{v.createdDate},#{v.totalIncome},#{v.totalRoomNum},#{v.realLiveNum},#{v.emptyRoomNum},#{v.avgPrice},#{v.livePercent},#{v.innCode})
            </foreach>
        </if>
    </insert>

    <select id="obtOpeDetail" parameterType="com.fanqie.dc.dto.ParamDto" resultMap="mapId">
     SELECT MAX(o.total_income) total_income,
     MAX(o.total_room_num) total_room_num,
     MAX(o.real_live_num) real_live_num,
     AVG(o.avg_price) avg_price,
     AVG(o.live_percent) live_percent,
     MAX(o.empty_room_num) empty_room_num,
     o.create_date from operate_trend  o
     LEFT JOIN bang_inn b ON b.inn_id = o.inn_id
     LEFT JOIN user_info u ON u.id = b.user_id
     LEFT JOIN inn_label lab ON lab.id = b.inn_label_id
     where 1=1
     and o.create_date BETWEEN '2015-04-01 00:00:00' AND '2015-04-07 23:59:59'
        <if test="!dataPermission">
            and b.user_id = '${userId}'
        </if>
        <if test="dataPermission">
            and b.company_id='${companyId}'
        </if>
        <if test="tagId!=null and tagId!=''">
            AND b.inn_label_id ='${tagId}'
        </if>

     GROUP BY o.create_date   ORDER  by o.create_date
    </select>

    <select id="obtGeneralOperateTrend" parameterType="com.fanqie.dc.dto.ParamDto" resultMap="mapId">
       SELECT SUM(oo.total_income) as total_income,SUM(oo.total_room_num) as total_room_num,
        SUM(oo.real_live_num) as real_live_num,
        SUM(oo.empty_room_num) as empty_room_num
         from (

        SELECT o.total_income,o.total_room_num,o.real_live_num,o.avg_price,o.live_percent,o.empty_room_num from operate_trend  o
        LEFT JOIN bang_inn b ON b.inn_id = o.inn_id
        LEFT JOIN user_info u ON u.id = b.user_id
        LEFT JOIN inn_label lab ON lab.id = b.inn_label_id
        where 1=1 and o.create_date BETWEEN '2015-04-01 00:00:00' AND '2015-05-13 23:59:59'
        <if test="!dataPermission">
            and b.user_id = '${userId}'
        </if>
        <if test="dataPermission">
            and b.company_id='${companyId}'
        </if>
        <if test="tagId!=null and tagId!=''">
            AND b.inn_label_id ='${tagId}'
        </if>
        ) oo
    </select>




</mapper>